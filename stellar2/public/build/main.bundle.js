(()=>{"use strict";function t(t){this.id=t}function e(){this._generation={},this._free_indices=[],this._entities={},this._components={},this.__entities_with_type={}}function i(t,e){return Math.sqrt((t.x-e.x)*(t.x-e.x)+(t.y-e.y)*(t.y-e.y))}function n(t){return Math.sqrt(t.x*t.x+t.y*t.y)}function s(t,e,i,n){return n?{x:(e.x-t.x+(n.x-i.x))/2,y:(e.y-t.y+(n.y-i.y))/2}:{x:e.x-t.x,y:e.y-t.y}}function o(t,e,n,s){if(!s)return 1;if(!n)return 1;let o=i(t,n),a=i(e,s);return o<.01?1:a/o}function a(t,e,i,n){if(!n)return 0;let s=r(t,i);return r(e,n)-s}function r(t,e){let i=s(t,e);return Math.atan2(i.y,i.x)}function h(t,e){this.deadzone=e,this.clear();let r=null,h=null,c=null,l=null,u=0,p=!0,g=!1,d=!1;this.centerPosition={x:0,y:0},this.debug=!1,this.console_error=!1,this.throw_error=!1,this.last_error="";const f=t=>{t.preventDefault();const{top:e,left:i}=t.target.getBoundingClientRect();if(t.touches[1]&&t.touches[0]){let n={x:t.touches[0].clientX-i,y:t.touches[0].clientY-e},s={x:t.touches[1].clientX-i,y:t.touches[1].clientY-e};return this.centerPosition={x:(n.x+s.x)/2,y:(n.y+s.y)/2},y(n,s)}if(t.touches[0]){let n={x:t.touches[0].clientX-i,y:t.touches[0].clientY-e};return this.centerPosition={x:n.x,y:n.y},y(n)}},m=t=>{t.preventDefault();const{top:e,left:i}=t.target.getBoundingClientRect();this.centerPosition={x:t.clientX-i,y:t.clientY-e},u&&y({x:t.clientX-i,y:t.clientY-e})},y=(t,e)=>{if(g=!0,null==r)return r={x:t.x,y:t.y},c={x:t.x,y:t.y},this.triger("start",c),void(p=!0);if(e&&null==h)return d=!0,i(r,e)<i(r,t)&&(r={x:t.x,y:t.y},c={x:t.x,y:t.y}),h={x:e.x,y:e.y},void(l={x:e.x,y:e.y});if(!e&&h)return d=!1,h=null,void(l=null);let f=s(c,t,l,e),m=o(c,t,l,e),y=a(c,t,l,e);c={x:t.x,y:t.y},l=e?{x:e.x,y:e.y}:null;let v=s(r,c,h,l),x=o(r,c,h,l),w=n(v),M=a(r,c,h,l),b=this.debug&&`${r&&"Start: "+JSON.stringify(r)},\n\t\t${c&&"This: "+JSON.stringify(c)}, \n\t\t${h&&"Start secound: "+JSON.stringify(h)}, \n\t\t${l&&"Start this: "+JSON.stringify(l)},\n\t\t${f&&"Delta: "+JSON.stringify(f)},\n\t\t${"Zoom: "+x},\n\t\t${"DZoom: "+m}\n\t\t${"Angle: "+M}\n\t\t${"DAngle: "+y}\n\t\t${"isPrimary: "+(!d&&0==u||1==u)}\n\t\t${this.last_error}`,S={delta:f,direction:v,startPosition:r,position:c,distance:w,click:p,isClick:p,mouseDown:u,zoom:x,deltaZoom:m,touchSecound:d,angle:M,deltaAngle:y,isPrimary:!d&&0==u||1==u,debug:b,centerPosition:this.centerPosition};this.triger("force",S),w>this.deadzone&&(p=!1,Math.abs(v.x)>Math.abs(v.y)?v.x>0?this.triger("right",S):this.triger("left",S):v.y>0?this.triger("down",S):this.triger("up",S))},v=t=>{if(t.preventDefault(),0==g)return;let e={x:0,y:0},i=s(r,c,h,l),f=o(r,c,h,l),m=a(r,c,h,l),y=n(i),v=this.debug&&`${r&&"Start: "+JSON.stringify(r)},\n\t\t${c&&"This: "+JSON.stringify(c)}, \n\t\t${h&&"Start secound: "+JSON.stringify(h)}, \n\t\t${l&&"Start this: "+JSON.stringify(l)},\n\t\t${e&&"Delta: "+JSON.stringify(e)},\n\t\t${"Zoom: "+f},\n\t\tDZoom: 0\n\t\t${"Angle: "+m}\n\t\tDAngle: 0\n\t\t${"isPrimary: "+(!d&&0==u||1==u)}\n\t\t${this.last_error}`;const x={x:r.x,y:r.y,delta:e,direction:i,startPosition:r,position:c,distance:y,click:p,isClick:p,mouseDown:u,zoom:f,deltaZoom:0,touchSecound:d,angle:m,deltaAngle:0,isPrimary:!d&&0==u||1==u,debug:v,centerPosition:this.centerPosition};g=!1,d=!1;let w=r;p&&(t.button?(1===t.button&&this.triger("bmiddle",x),2===t.button&&this.triger("bright",x)):w&&this.triger("click",x)),this.triger("stop",x),r=null,c=null,h=null,l=null,u=0};t.addEventListener("touchstart",(t=>{t.preventDefault()}),!1),t.addEventListener("touchmove",f,!1),t.addEventListener("touchend",v,!1),t.addEventListener("touchstart",f,!1),t.addEventListener("mouseleave",v,!1),t.addEventListener("mousemove",m),t.addEventListener("mouseup",v),t.addEventListener("mousedown",(t=>{u=1+t.button,m(t)}))}t.prototype.index=function(){return 4194303&this.id},t.prototype.generation=function(){return this.id>>22&255},e.prototype.create=function(){var t=0;this._free_indices.length>0?t=this._free_indices.shift():(t=Object.keys(this._generation).length,this._generation[t]=0);var e=this.make_entity(t,this._generation[t]);return this._entities[t]=e,e},e.prototype.make_entity=function(e,i){return new t(e+(i<<22))},e.prototype.alive=function(t){return this._generation[t.index()]==t.generation()},e.prototype.destroy=function(t){this._components[t.id]=void 0,this._entities[t.id]=void 0,++this._generation[t.index()],this._free_indices.push(t.index())},e.prototype.asign=function(t,e){var i=this._components[e.id];if(i){var n=i[t.constructor.name];if(n){if(n&&i[t.constructor.name].find((e=>t===e)))throw Error("Component is allready asiged");i[t.constructor.name].push(t)}else this._components[e.id][t.constructor.name]=[t]}else this._components[e.id]={[t.constructor.name]:[t]}},e.prototype.get=function(t,e){var i=this._components[e.id];return i&&i[t.name]||[]},e.prototype.remove=function(t,e){var i=this._components[e.id];i&&i[t.constructor.name]&&(i[t.constructor.name]=i[t.constructor.name].filter((function(e){return e!==t})))},e.prototype.getEnities=function(t){return Object.values(this._entities).filter((e=>e&&this.get(t,e).length))},h.prototype.sub=function(t,e){this.events[t]&&this.events[t].push(e)},h.prototype.onClick=function(t){this.events.click.push(t)},h.prototype.onForce=function(t){this.events.force.push(t)},h.prototype.onStop=function(t){this.events.stop.push(t)},h.prototype.onUp=function(t){this.events.up.push(t)},h.prototype.onDown=function(t){this.events.down.push(t)},h.prototype.onLeft=function(t){this.events.left.push(t)},h.prototype.onRight=function(t){this.events.right.push(t)},h.prototype.unsub=function(t,e){this.events[t]&&(this.events[t]=this.events[t].filter((t=>t!==e)))},h.prototype.clearEvlent=function(t){this.events[t]&&(this.events[t]=[])},h.prototype.clear=function(){this.events={up:[],down:[],left:[],right:[],stop:[],start:[],click:[],force:[],bmiddle:[],bright:[]}},h.prototype.triger=function(t,e){this.events[t]&&this.events[t].forEach((t=>{try{t(e)}catch(t){if(this.console_error&&console.log(t),this.last_error="Error: "+t.name+" "+t.foo+" "+t.message+" "+t.stack,this.throw_error)throw t}}))};const c=h;function l(...t){if(Array.call(this),1==t.length){var e=t[0],i=Object.values(e);Object.hasOwnProperty.call(e,"length")&&e.length!==i.length&&i.pop(),this.push(...i)}else this.push(...Object.values(t));Object.defineProperty(this,"x",{get(){return this[0]},set(t){this[0]=t}}),Object.defineProperty(this,"y",{get(){return this[1]},set(t){this[1]=t}}),Object.defineProperty(this,"z",{get(){return this[2]},set(t){this[2]=t}})}function u(t){this.positions=new l(t)}function p(t,e,i){this.speeds=new l(t),this.mass=e,this.drag=isNaN(i)?.001:i,this.maxSpeed=100}function g(t,e){this.manager=t,this.engines=e}function d(t){this.radius=t}function f(){}function m(t){this.manager=t,this.physic_entity=null}function y(t,e){var i=[];return e.forEach((e=>{if(e!=t){var n=e.positions[0]-t.positions[0],s=e.positions[1]-t.positions[1],o=t.radius+e.radius;Math.abs(n)>o||Math.abs(s)>o||function(t,e){for(var i=0,n=0;n<t.positions.length;n++)i+=Math.pow(t.positions[n]-e.positions[n],2);return i}(t,e)>Math.pow(o,2)||t.radius>e.radius&&i.push(e)}})),i}function v(t,e){this.manager=t,this.interaction=e||.1}function x(t,e,i){var n=[0,0];return e.forEach((e=>{if(e!=t){var s=e.positions[0]-t.positions[0],o=e.positions[1]-t.positions[1],a=s*s+o*o,r=Math.sqrt(a),h=e.mass/a*i;n[0]+=s/r*h,n[1]+=o/r*h}})),n}function w(t,e){this.x=t,this.y=e}function M(t,e){this.font=t,this.text=e}function b(t){this.image=t}function S(t){this.radius=t}function _(t){this.rotate=t}function E(){this.noscale=!0}function P(t){this.scale=t}function D(t,e,i){this.color=t,this.stroke=e,this.layer=i||0}function O(t,e){this.context=t,this.manager=e,this.maxSize=100}function N(t,e){e.color&&(t.fillStyle=e.color,t.fill()),e.stroke&&(t.strokeStyle=e.stroke.color,t.lineWidth=e.stroke.width,t.stroke())}function T(t,e,i,n,s,o){t.moveTo(e,i+o),t.lineTo(e,i+s-o),t.arcTo(e,i+s,e+o,i+s,o),t.lineTo(e+n-o,i+s),t.arcTo(e+n,i+s,e+n,i+s-o,o),t.lineTo(e+n,i+o),t.arcTo(e+n,i,e+n-o,i,o),t.lineTo(e+o,i),t.arcTo(e,i,e,i+o,o)}function k(t){this.manager=t}function I(t,e,i,n,s,o,a){return[(o-t)*i+n/2,(a-e)*i+s/2]}function A(t,e,i,n,s,o,a){return[(o-n/2)/i+t,(a-s/2)/i+e]}function $(t){this.canvas=t,this.context=this.canvas.getContext("2d",{willReadFrequently:!0}),this.img=this.context.createImageData(this.canvas.width,this.canvas.height)}l.prototype.x=0,l.prototype.y=0,l.prototype.z=0,l.prototype=Object.create(Array.prototype,{constructor:{value:l,enumerable:!1,writable:!0,configurable:!0}}),l.prototype.add=function(t){let e=this.copy();for(var i=0;i<e.length;i++)Object.hasOwnProperty.call(e,i)&&Object.hasOwnProperty.call(t,i)&&(e[i]+=t[i]);return e},l.prototype.update=function(t){for(var e=0;e<this.length;e++)Object.hasOwnProperty.call(this,e)&&Object.hasOwnProperty.call(t,e)&&(this[e]=t[e])},l.prototype.negate=function(){let t=this.copy();for(var e=0;e<t.length;e++)Object.hasOwnProperty.call(t,e)&&(t[e]=-t[e]);return t},l.prototype.substract=function(t){return this.add(t.negate())},l.prototype.magnitude=function(){let t=0;for(var e=0;e<this.length;e++)Object.hasOwnProperty.call(this,e)&&(t+=this[e]*this[e]);return Math.sqrt(t)},l.prototype.normalise=function(t){let e=this.magnitude();return this.scale(1/e)},l.prototype.scale=function(t){let e=this.copy();for(var i=0;i<e.length;i++)Object.hasOwnProperty.call(e,i)&&(e[i]*=t);return e},l.prototype.copy=function(){return new this.constructor(this)},p.prototype.applyForce=function(t){for(var e=0;e<this.speeds.length;e++){if(isNaN(t[e]))throw new Error("Physics.prototype.applyForce got NnN");this.speeds[e]+=t[e]/this.mass}},p.prototype.applyAsc=function(t){for(var e=0;e<this.speeds.length;e++){if(isNaN(t[e]))throw new Error("Physics.prototype.applyAsc got NnN");this.speeds[e]+=t[e]}},p.prototype.compute=function(){var t,e=0;for(t=0;t<this.speeds.length;t++)e+=this.speeds[t]*this.speeds[t];var i=Math.min(1-this.drag,this.maxSpeed/e);for(t=0;t<this.speeds.length;t++)this.speeds[t]*=i},g.prototype.compute=function(){this.engines.forEach((t=>t.compute())),this.manager.getEnities(p).forEach((t=>{var e=this.manager.get(p,t)[0];e.compute();var i=this.manager.get(u,t)[0];i.positions=i.positions.add(e.speeds)}))},m.prototype.compute=function(){for(var t=this.manager.getEnities(p).filter((t=>this.manager.get(f,t)[0])).map((t=>{var e=this.manager.get(d,t)[0],i=this.manager.get(u,t)[0],n=this.manager.get(p,t)[0];return{e:t,radius:e.radius,circle:e,positions:i.positions,speeds:n.speeds,physics:n}})),e=0;e<t.length;e++){var i=t[e];if(this.manager.alive(i.e)){var n=y(i,t);for(var s in n){var o=n[s];this.manager.alive(o.e)&&(this.manager.destroy(o.e),this.merge(i,o))}}}},m.prototype.merge=function(t,e){var i=Math.pow(t.radius,3),n=Math.pow(e.radius,3),s=Math.cbrt(i+n);t.circle.radius=s;var o=t.physics.mass,a=e.physics.mass;t.physics.mass=o+a;for(var r=0;r<t.speeds.length;r++)t.speeds[r]=(t.speeds[r]*o+e.speeds[r]*a)/(o+a)},v.prototype.compute=function(){for(var t=this.manager.getEnities(p).map((t=>{var e=this.manager.get(p,t)[0],i=this.manager.get(u,t)[0];return{e:t,mass:e.mass,physics:e,positions:i.positions}})),e=0;e<t.length;e++){var i=t[e],n=x(i,t,this.interaction);i.physics.applyAsc(n)}},O.prototype.draw=function(t){const{context:e}=this;var i=e.canvas.clientWidth,n=e.canvas.clientHeight;const{x:s,y:o,scale:a,angle:r}=t,h=i/2,c=n/2,l=this.maxSize*a;r&&(e.save(),e.translate(h,c),e.rotate(r),e.translate(-h,-c)),this.manager.getEnities(D).map((t=>[t,this.manager.get(D,t)[0]])).sort((([,t],[,e])=>t.layer<e.layer?-1:t.layer>e.layer?1:0)).map((([t,r])=>{var p=this.manager.get(u,t)[0],g=(p.positions[0]-s)*a+h,f=(p.positions[1]-o)*a+c;if(g<-l||f<-l||g>i||f>n)return;let m=this.manager.get(E,t)[0],y=this.manager.get(P,t)[0],v=m?1:a*(y?.scale||1),x=this.manager.get(d,t);for(let t in x){let i=x[t];const n=i.radius*v>1?i.radius*v:1;e.beginPath(),e.arc(g,f,n,0,2*Math.PI,!1),N(e,r)}let D=this.manager.get(w,t),O=this.manager.get(S,t),k=this.manager.get(_,t)[0];for(let t in D){let i=D[t];const n=i.x*v>1?i.x*v:1,s=i.y*v>1?i.y*v:1;e.save(),k&&(e.translate(g+n/2,f+s/2),e.rotate(k.rotate),e.translate(-g-n/2,-f-s/2)),e.beginPath(),O[0]?T(e,g,f,n,s,O[0].radius):e.rect(g,f,n,s),N(e,r),e.restore()}let I=this.manager.get(b,t);for(let t in I){let i=I[t],n=D[0],s=n?.x||i.image.width,o=n?.x||i.image.height;const a=s*v>1?s*v+.5:1,r=o*v>1?o*v+.5:1;e.save(),k&&(e.translate(g+a/2,f+r/2),e.rotate(k.rotate),e.translate(-g-a/2,-f-r/2)),e.drawImage(i.image,g,f,a,r),e.restore()}let A=this.manager.get(M,t);for(let t in A){let i=A[t];const n=i.font*v>1?i.font*v:1;e.fillStyle=r.color,e.font=parseInt(n)+"px serif",e.save(),k&&(e.translate(g,f),e.rotate(k.rotate),e.translate(-g,-f)),e.fillText(i.text,g,f+parseInt(n)),e.restore()}})),r&&e.restore()},O.prototype.mesure=function(t){const{context:e}=this;return e.font=parseInt(t.font)+"px serif",e.measureText(t.text)},k.prototype.compute=function(){this.manager.getEnities(D).map((t=>{var e=this.manager.get(D,t)[0];if(e.color){var i=this.manager.get(p,t)[0].mass/(Math.pow(this.manager.get(d,t)[0].radius,3)*Math.PI)*10*Math.PI;e.color=i<1?"##00fffb":i<2?"#001eff":i<3?"#995500":i<4?"#ff8c00":"#fffb00"}}))},$.prototype.clear=function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height)},$.prototype.getCanvas=function(){return this.canvas},$.prototype.worldToScreen=function(t,e){const{width:i,height:n}=this.canvas,{x:s,y:o,scale:a}=t;return I(s,o,a,i,n,e[0],e[1])},$.prototype.screenToWorld=function(t,e){const{width:i,height:n}=this.canvas,{x:s,y:o,scale:a}=t;return A(s,o,a,i,n,e[0],e[1])};const C=$;function j(t){this.context=t,this.time=(new Date).getTime(),this.i=0,this.fps=0}j.prototype.draw=function(){this.i++;var t=(new Date).getTime(),e=t-this.time;this.time=t,this.context.font="14px Verdana",this.i%30||(this.fps=Math.round(1e4/e)/10+" fps"),this.context.beginPath(),this.context.rect(10,13,60,14),this.context.fillStyle="gray",this.context.fill(),this.context.fillStyle="red",this.context.fillText(this.fps,10,24)};const W=j;function L(t,e,i){return t*(1-i)+e*i}function B(t,e){this.context=t,this.showCords=e?.showCords,this.showAxis=e?.showAxis,this.axisCords=e?.axisCords,this.axisScale=e?.axisScale||100,this.devide=e?.devide||2}B.prototype.draw=function(t,e,i){const{context:n}=this;var s=n.canvas.clientWidth,o=n.canvas.clientHeight;const{x:a,y:r,scale:h}=i,c=s/2,l=o/2;for(var u=h||1;u>2;)u/=2;for(;u<1;)u*=2;const p=t*u,g=e*u;if((y=(c-a*h)%p)<0&&(y+=p),(v=(l-r*h)%g)<0&&(v+=g),this.showAxis){n.beginPath();let[t,e]=I(a,r,h,s,o,0,0);n.lineWidth=2,n.moveTo(t,0),n.lineTo(t,o),n.moveTo(0,e),n.lineTo(s,e),n.strokeStyle="rgba(0, 0, 0, 1.0)",n.stroke()}n.beginPath();for(var d=y;d<=s;d+=p){if(n.moveTo(d,0),n.lineTo(d,o),!this.axisCords)continue;let t=A(a,r,h,s,o,d,0)[0];this.drawCod(t,0,i,n)}for(var f=v;f<=o;f+=g){if(n.moveTo(0,f),n.lineTo(s,f),!this.axisCords)continue;let t=A(a,r,h,s,o,0,f)[1];this.drawCod(0,t,i,n)}n.lineWidth=2,n.strokeStyle="rgba(128, 128, 128, 0.5)",n.stroke();for(var m=0;m<this.devide-1;m++){var y=(y+p/this.devide)%p,v=(v+g/this.devide)%g;for(n.beginPath(),d=y;d<=s;d+=p)n.moveTo(d,0),n.lineTo(d,o);for(f=v;f<=o;f+=g)n.moveTo(0,f),n.lineTo(s,f);n.lineWidth=1,n.strokeStyle="rgba(128, 128, 128, "+L(.25,.5,u-1)+")",n.stroke()}this.showCords&&(n.font="10px Arial",n.fillText(Math.round(i.x*this.axisScale)/this.axisScale+Number.EPSILON+","+Math.round(i.y*this.axisScale+Number.EPSILON)/this.axisScale+","+Math.round(i.scale*this.axisScale+Number.EPSILON)/this.axisScale,10,50))},B.prototype.drawCod=function(t,e,i,n){const{x:s,y:o,scale:a}=i;var r=n.canvas.clientWidth,h=n.canvas.clientHeight,c=(t-s)*a+r/2,l=(e-o)*a+h/2;let u=!1;function p(t){return+parseFloat(t).toFixed(2)}(c<5||c>r-19||l>h-28||l<14)&&(u=!0),c<5&&(c=5),l<14&&(l=14),c>r-19&&(c=r-19),l>h-28&&(l=h-28),n.font="14px Verdana",n.fillStyle="rgb(0, 0, 0, 1.0)";let g="",d=p(t/this.axisScale),f=p(-e/this.axisScale);d&&(g+=d),f&&(g+=f),f||d||u||(g+="0"),n.fillText(g,c+5,l+14)},B.prototype.line=function(t,e,i,n,s){this.context.lineWidth=1,this.context.moveTo(t,e),this.context.lineTo(t+i,e+n),this.context.strokeStyle=s,this.context.stroke()};const F=B;function J(t,e){this.context=t,this.update(),this.manager=e}J.prototype.update=function(){this.width=this.context.canvas.clientWidth,this.height=this.context.canvas.clientHeight,this.img=this.context.createImageData(this.width,this.height)},J.prototype.pull=function(){this.img=this.context.getImageData(0,0,this.width,this.height)},J.prototype.imgRect=function(t,e,i,n,s){null==s[3]&&s.push(Math.min(2*((t,e)=>{for(var i=0,n=0;n<t.length;n++)i+=(t[n]-e[n])*(t[n]-e[n]);return isNaN(i)||i<1?1:Math.sqrt(i)})(s,[0,0,0]),255));const o=Math.max(Math.min(i,this.width-t),0),a=Math.max(Math.min(n,this.height-e),0),r=Math.max(Math.round(t),0),h=Math.max(Math.round(e),0),c=this.img.data,l=4*r,u=4*o+l,p=4*this.width,g=h*p,d=a*p+g,f=s[3]/255;for(var m=g;m<d;m+=p)for(var y=l;y<u;y+=4){var v=m+y;c[v]=L(c[v],s[0],f),c[v+1]=L(c[v+1],s[1],f),c[v+2]=L(c[v+2],s[2],f),c[v+3]=Math.max(s[3],c[v+3])}};const R=(t,e)=>{for(var i=0,n=0;n<t.length;n++)i+=Math.pow(t[n]-e.positions[n],2);return isNaN(i)||i<1?1:i};function q(t,e){this.context=t,this.imgData=new J(t,e),this.manager=e}q.prototype.update=function(){this.imgData.update()},q.prototype.draw=function(t){const{x:e,y:i,scale:n}=t,{context:s}=this;var o=s.canvas.clientWidth,a=s.canvas.clientHeight;const r=o/2,h=a/2;var c=(e+r)%2,l=(i+h)%2,g=2/n;const d=this.manager.getEnities(p).map((t=>{var e=this.manager.get(p,t)[0],i=this.manager.get(u,t)[0];return{mass:e.mass,positions:i.positions}}));this.imgData.pull();for(var f=c;f<=o;f+=2)for(var m=(f-r)/n+e,y=(l-h)/n+i,v=l;v<=a;v+=2){for(var x=0,w=d.length,M=0;M<w;M++){var b=d[M];x+=3e3*b.mass/R([m,y],b)}var S=Math.min(x/16,255),_=Math.max(Math.min(x,255)-S*S*.3,0);this.imgData.imgRect(f-1,v-1,2,2,[S,0,_]),y+=g}s.putImageData(this.imgData.img,0,0)},q.prototype.imgRect=function(t,e,i,n,s){const o=Math.max(Math.min(i,this.context.canvas.clientWidth-t),0),a=Math.max(Math.min(n,this.context.canvas.clientHeight-e),0),r=Math.max(Math.round(t),0),h=Math.max(Math.round(e),0),c=this.img.data,l=4*r,u=4*o+l,p=4*this.context.canvas.clientWidth,g=h*p,d=a*p+g;for(var f=g;f<d;f+=p)for(var m=l;m<u;m+=4){var y=f+m;c[y]=s[0],c[y+1]=s[1],c[y+2]=s[2],c[y+3]=s[3]}};const H=q,z=(t,e)=>{for(var i=0,n=0;n<t.length;n++)i+=(t[n]-e[n])*(t[n]-e[n]);return isNaN(i)||i<1?1:Math.sqrt(i)};function Z(t,e,i){this.colors=i,this.context=t,this.imgData=new J(t,e),this.manager=e}Z.prototype.update=function(){this.imgData.update()},Z.prototype.draw=function(t){const{x:e,y:i,scale:n}=t,{context:s}=this;var o=s.canvas.clientWidth,a=s.canvas.clientHeight;const r=o/2,h=a/2;var c=(e+r)%2,l=(i+h)%2,g=2/n;const d=this.manager.getEnities(p).map((t=>{var e=this.manager.get(p,t)[0],i=this.manager.get(u,t)[0];return{mass:e.mass,positions:i.positions}}));this.imgData.pull();for(var f=new Array(this.colors.length).fill(0),m=c;m<=o;m+=2)for(var y=(m-r)/n+e,v=(l-h)/n+i,x=l;x<=a;x+=2){for(var w=0,M=d.length,b=0;b<M;b++){var S=d[b];w+=S.mass/z([y,v],S.positions)}var _=Math.max(this.colors.length-w/64,0),E=_%1,P=Math.min(this.colors.length-1,Math.floor(_)),D=Math.min(this.colors.length-1,Math.ceil(_)),O=this.colors[D];let t=this.colors[P];f[P]++,O=O.map(((e,i)=>L(t[i],e,E))),this.imgData.imgRect(m-1,x-1,2,2,[O[0],O[1],O[2]]),v+=g}s.putImageData(this.imgData.img,0,0)};const X=Z;function Y(t,e){this.context=t,this.imgData=new J(t,e),this.update(),this.manager=e}Y.prototype.update=function(){this.width=this.context.canvas.clientWidth,this.height=this.context.canvas.clientHeight,this.step=4,this.widthSteps=this.width/this.step,this.heightSteps=this.height/this.step,this.number=this.widthSteps*this.heightSteps,this.cells={p:new Float32Array(this.number),v:new Float32Array(this.number),h:new Float32Array(this.number),o:new Uint8Array(this.number)},this.cells.p.fill(1),this.cells.v.fill(0),this.cells.h.fill(0),this.cells.o.fill(0),this.imgData.update()},Y.prototype.draw=function(t){const{x:e,y:i,scale:n}=t,{context:s}=this;var o=s.canvas.clientWidth,a=s.canvas.clientHeight;const r=o/2,h=a/2,c=this.step,l=this.step,g=c/2,f=l/2;var m=(e+r)%c,y=(i+h)%l,v=l/n;this.imgData.pull();const x=this.manager.getEnities(p).map((t=>{var e=this.manager.get(u,t)[0],i=this.manager.get(d,t)[0];return{speeds:this.manager.get(p,t)[0].speeds,radius:i&&i.radius,positions:e.positions}})).filter((({radius:t})=>!!t));for(var w=m;w<=o;w+=c)for(var M=(w-r)/n+e,b=(y-h)/n+i,S=Math.max(Math.round(M-g),0),_=y;_<=a;_+=l){for(var E=S+Math.max(Math.round(b-f),0)*this.widthSteps,P=0,D=x.length,O=0;O<D;O++){var N=x[O];N.radius>(I=N.positions[0],A=N.positions[1],function(t,e){return Math.sqrt(t*t,e*e)}(I-M,A-b))&&(this.cells.o[E]=1)}this.cells[E]&&(P+=128);var T=Math.min(P,255),k=Math.max(Math.min(P,255)-T*T*.3,0);this.imgData.imgRect(w-g,_-f,c,l,[255-k,0,255-T]),b+=v}var I,A;s.putImageData(this.imgData.img,0,0)};const U=Y;function V(t,e){this.connects=t,this.distance=e}function G(t){this.manager=t}G.prototype.compute=function(){this.manager.getEnities(V).map((t=>{var e=this.manager.get(V,t).map((t=>({transform:this.manager.get(u,t.connects)[0],distance:t.distance}))),i=this.manager.get(u,t)[0],n=this.manager.get(p,t)[0],s=function(t,e){var i=[0,0];return t.forEach((({transform:t,distance:n})=>{var s=t.positions[0]-e.positions[0],o=t.positions[1]-e.positions[1],a=Math.atan2(o,s),r=Math.sqrt(s*s+o*o)/n,h=Math.atan(5*(r-1))+Math.pow(r-1,3),c=Math.cos(a)*h,l=Math.sin(a)*h;i[0]+=c,i[1]+=l})),i}(e,i);n.applyForce(s)}))};const K=document.getElementById("phy_canvas"),Q=document.getElementById("tolook_value"),tt=document.getElementById("draw_mass"),et=document.getElementById("draw_galaxy"),it=document.getElementById("draw_gass"),nt=document.getElementById("draw_grid"),st=document.getElementById("draw_fps"),ot=document.getElementById("full_speed"),at=document.getElementById("draw_planets");var rt=new C(K);K.width=640,K.height=480;var ht={x:0,y:0,scale:.2};window.addEventListener("mousewheel",(function(t){ht.scale*=t.wheelDelta>0?1.1:.88}));const ct=new W(rt.context),lt=new F(rt.context);var ut=new e;const pt=new O(rt.context,ut),gt=new H(rt.context,ut),dt=new X(rt.context,ut,[[255,255,255],[111,196,165],[163,123,173],[147,108,161],[44,78,138],[62,27,156],[100,24,29],[21,5,34],[10,12,29],[0,0,0]]),ft=new U(rt.context,ut),mt=new v(ut),yt=new m(ut),vt=new k(ut),xt=new G(ut),wt=new g(ut,[mt,yt,vt,xt]);new c(K,100).sub("force",(({delta:t,deltaZoom:e})=>{ht={...ht,scale:ht.scale*e,x:ht.x-t.x/ht.scale,y:ht.y-t.y/ht.scale}}));var Mt=null,bt=[];function St(t,e,i){return Mt=ut.create(),ut.asign(new u(t),Mt),ut.asign(new p(e,function(t){return Math.pow(t,3)*Math.PI*.1}(i),0),Mt),ut.asign(new d(i),Mt),ut.asign(new D("#aaffbb"),Mt),ut.asign(new f,Mt),Mt}bt.push(St([0,0],[0,0],55)),bt.push(St([255,0],[0,5],3)),bt.push(St([300,0],[0,5],4)),bt.push(St([450,0],[0,4],7)),bt.push(St([600,0],[0,4],4));let _t=St([1400,0],[0,2.5],35);bt.push(_t),bt.push(St([1440,0],[0,6],2)),bt.push(St([1450,0],[0,6],2)),bt.push(St([2800,0],[0,2.5],5));const Et=t=>{var e=2*Math.random()*Math.PI,i=200+2e3*Math.random(),n=Math.sin(e)*i,s=Math.cos(e)*i,o=Math.atan2(n,s)-Math.PI/2,a=St([n,s],[10*Math.sin(o)+14*Math.random()-7,10*Math.cos(o)+14*Math.random()-7],t||.1+Math.random());bt.push(a)};for(let t=0;t<1e3;t++)Et(10);setInterval((()=>{bt.length<30&&Et()}),200),function t(){var e=parseInt(Q.value);if(!isNaN(e)){var i=bt[e%bt.length],n=ut.get(u,i)[0];ht.x=n.positions[0],ht.y=n.positions[1]}rt.clear(),nt.checked&&lt.draw(100,100,ht),tt.checked&&gt.draw(ht),it.checked&&ft.draw(ht),et.checked&&dt.draw(ht),at.checked&&pt.draw(ht),st.checked&&ct.draw(),wt.compute(),bt=bt.filter((function(t,i){var n=ut.alive(t);return!n&&!isNaN(e)&&e>=i&&(Q.value=e-1),n})),e>=bt.length&&(Q.value=bt.length-1),setTimeout(t,ot.checked?0:15)}()})();